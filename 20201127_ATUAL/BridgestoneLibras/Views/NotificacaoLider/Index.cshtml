<!DOCTYPE html>

    <html>
    <head>
        <title>Notificação Líder</title>
    </head>



    <body>
        <ul class="breadcrumb" style="color:red">
            <li>Notificação Líder</li>
        </ul>


        <div class="container">
            <div class="row text-center" style="margin-top:20px;">
                <div class="col-lg-3">
                    <label>Departamento</label>
                </div>
                <div class="col-lg-2">
                    <label>Maquina</label>
                </div>
                <div class="col-lg-2">
                    <label>Parte Máquina</label>
                </div>
                <div class="col-lg-3">
                    <label>Formulários</label>
                </div>
                <div class="col-lg-2">
                    <label>Respondidas</label>
                </div>
                <div class="col-lg-2">

                </div>

            </div>
            <div class="row">
                <div class="col-lg-3">
                    <select id="lstDepartamento" onchange="ComboMaquina();" name="departamento" class="form-control"></select>
                </div>
                <div class="col-lg-2">
                    <select id="lstMaquina" onchange="ComboParteMaquina();" name="maquinas" class="form-control"></select>
                </div>
                <div class="col-lg-3">
                    <select id="lstParteMaquina" onchange="ComboFormulario();" name="parteMaquina" class="form-control"></select>
                </div>
                <div class="col-lg-2">
                    <select id="lstFormulario" name="recursoCentroCusto" class="form-control"></select>
                </div>
                <div class="col-lg-2 text-center">
                    <div class="checkbox">
                        <label><input id="chkResp" type="checkbox"></label>
                    </div>
                </div>

            </div>
            <div class="row" style="margin-top: 16px;">
                <div class="col-lg-4">
                </div>
                <div class="col-lg-2">
                    <button type="button" id="btnConsultar" onclick="Consultar();" class="btn btn-outline-danger btn-block "><span style="color: black;" class="glyphicon glyphicon-search"></span></button>
                </div>
                <div class="col-lg-2">
                    <button type="button" onclick="Limpar()" class="btn btn-outline-secondary  btn-block">Limpar</button>
                </div>
                <div class="col-lg-4">

                </div>
            </div>

        </div>

        <div class="modal fade" id="modalAlert" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="margin-top: 136px;">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Informação</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="msnAlert"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal" style="margin:auto; background-color: black;">Ok</button>
                    </div>
                </div>
            </div>
        </div>


        <div class="modal fade" id="modalmsn" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="margin-top: 136px;">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Informação</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="idmsn"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal" style="margin:auto; background-color: black;">Ok</button>
                    </div>
                </div>
            </div>
        </div>


        <div class="modal fade" id="ModalNotificacao" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="margin-top: 136px;">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Notificação Operador</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="exampleFormControlTextarea2">Notificação</label>
                            <textarea class="form-control rounded-0" id="idtxtNotificacaoObs" rows="5"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="btnReposnderNotificacao" data-dismiss="modal" class="btn btn-outline-danger  btn-block" onclick="ModalObsLider(this)" style="margin-top: 0px;">Responder Notificação</button>
                        <button type="button" data-dismiss="modal" class="btn btn-outline-dark  btn-block" style="margin-top: 0px;">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="ModalObsLider" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="margin-top: 136px;">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Notificação Lider</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="msnObsLider"></div>
                        <div class="form-group">
                            <label for="exampleFormControlTextarea2">Notificação</label>
                            <textarea class="form-control rounded-0" onkeypress="LimparCampo();" id="idtxtObsLider" rows="5"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">

                        <button type="button" class="btn btn-outline-dark  btn-block" onclick="CadastrarObsLider();" style="margin-top: 0px;">Salvar</button>
                        <button type="button" data-dismiss="modal" class="btn btn-outline-dark  btn-block" style="margin-top: 0px;">Fechar</button>
                    </div>
                </div>
            </div>
        </div>


        <div class="modal fade" id="ModalNotificacaoObsLider" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="margin-top: 136px;">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Notificação Lider</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">

                        <div class="form-group">
                            <label for="exampleFormControlTextarea2">Notificação</label>
                            <textarea class="form-control rounded-0" id="idTxtNotificacaoObsLider" rows="5"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">

                        <button type="button" data-dismiss="modal" class="btn btn-outline-dark  btn-block" style="margin-top: 0px;">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="container" style="margin-top:20px;">
            <div id="conteudo"></div>

        </div>
    </body>
</html>
<style>
    .dtHorizontalExampleWrapper {
        max-width: 600px;
        margin: 0 auto;
    }

    #dtHorizontalExample th, td {
        white-space: nowrap;
    }

    table.dataTable thead .sorting:after,
    table.dataTable thead .sorting:before,
    table.dataTable thead .sorting_asc:after,
    table.dataTable thead .sorting_asc:before,
    table.dataTable thead .sorting_asc_disabled:after,
    table.dataTable thead .sorting_asc_disabled:before,
    table.dataTable thead .sorting_desc:after,
    table.dataTable thead .sorting_desc:before,
    table.dataTable thead .sorting_desc_disabled:after,
    table.dataTable thead .sorting_desc_disabled:before {
        bottom: .5em;
    }
</style>

<script>
    (function () {



        var permissao = "";
        ConsultarDepartamento();
        ComboMaquina();
        Tabela();
        var dados = "";
        var idRegistro = 0;
        CarregaGrid();

    })();

    function CarregaGrid() {


        $.ajax({
            url: "CarregaGrid/NotificacaoLider",
            dataType: 'json',
            type: 'GET',
            success: function (data) {
                dados = data
                Grid(data);
            },
            error: function (data) {
                alert("erro");
                console.log(data);
            }
        });

    }

    function ConsultarDepartamento() {
        $.ajax({
            url: "Departamento/NotificacaoLider",
            dataType: 'json',
            type: 'GET',
            success: function (data) {
                var obj = data;
                $("#lstDepartamento").html("");
                if (obj.length == 0) {
                    $("#lstDepartamento").prop('disabled', true);
                } else {
                    $("#lstDepartamento").prop('disabled', false);
                    $.each(obj, function (i, index) {
                        $("#lstDepartamento").append(
                            $('<option></option>').val(index.value).html(index.text));
                    })
                    $("#lstDepartamento").prop('selectedIndex');
                }
            },
            error: function (data) {
                alert("erro");
                console.log(data);
            }
        });
    }

    function ComboMaquina() {
        $.ajax({
            url: "Maquinas/NotificacaoLider?idDepartamento=" + $("#lstDepartamento").val(),
            dataType: 'json',
            type: 'GET',
            success: function (data) {
                var obj = data;
                $("#lstMaquina").html("");
                if (obj.length == 0) {
                    $("#lstMaquina").prop('disabled', true);
                } else {
                    $("#lstMaquina").prop('disabled', false);
                    $.each(obj, function (i, index) {
                        $("#lstMaquina").append(
                            $('<option></option>').val(index.value).html(index.text));
                    })
                    $("#lstMaquina").prop('selectedIndex');
                }
            },
            error: function (data) {
                alert("erro");
                console.log(data);
            }
        });
    }

    function ComboParteMaquina() {

        $.ajax({
            url: "MaquinaParte/NotificacaoLider?idMaquina=" + $("#lstMaquina").val(),
            dataType: 'json',
            type: 'GET',
            success: function (data) {
                var obj = data;
                $("#lstParteMaquina").html("");
                if (obj.length == 0) {
                    $("#lstParteMaquina").prop('disabled', true);
                } else {
                    $("#lstParteMaquina").prop('disabled', false);
                    $.each(obj, function (i, index) {
                        $("#lstParteMaquina").append(
                            $('<option></option>').val(index.value).html(index.text));
                    })
                    $("#lstParteMaquina").prop('selectedIndex');
                }
            },
            error: function (data) {
                alert("erro");
                console.log(data);
            }
        });
    }

    function ComboFormulario() {
        $.ajax({
            url: "Formularios/NotificacaoLider?idParteMaquina=" + $("#lstParteMaquina").val(),
            dataType: 'json',
            type: 'GET',
            success: function (data) {
                var obj = data;
                $("#lstFormulario").html("");
                if (obj.length == 0) {
                    $("#lstFormulario").prop('disabled', true);
                } else {
                    $("#lstFormulario").prop('disabled', false);
                    $.each(obj, function (i, index) {
                        $("#lstFormulario").append(
                            $('<option></option>').val(index.value).html(index.text));
                    })
                    $("#lstFormulario").prop('selectedIndex');
                }
            },
            error: function (data) {
                alert("erro");
                console.log(data);
            }
        });
    }

    function Validar() {


        if ($("#lstFormulario").val() == null) {
            ModalAlertMsn("Por favor, informe o Formulário.");
            return false;
        }
        if ($("#lstFormulario").val() == "0") {
            ModalAlertMsn("Por favor, informe o Formulário.");
            return false;
        }
        return true;
    }


    function ModalAlertMsn(msn) {
        $("#modalAlert").modal('show');
        var resposta = '';
        $("#msnAlert").empty();
        resposta = "<div class='alert alert-danger  text-center' role='alert'>" + msn + "</div>";
        $("#msnAlert").append(resposta);
    }

    function ModalAlert(msn) {
        $("#modalmsn").modal('show');
        var resposta = '';
        $("#idmsn").empty();
        resposta = "<div class='alert alert-danger  text-center' role='alert'>" + msn + "</div>";
        $("#idmsn").append(resposta);
    }

    //function Limpar() {

    //    CarregaGrid();

    //    $("#lstFormulario").val(0);
    //    $("#lstParteMaquina").val(0);
    //    $("#lstMaquina").val(0);
    //    $("#lstDepartamento").val(0);

    //}


    function Consultar() {

        var active = $('#chkResp').prop("checked") ? 1 : 0;

        if ($("#lstFormulario").val() != null) {
            if (Validar()) {
                $.ajax({
                    url: "ConsultarNotificacao/NotificacaoLider?id_formulario=" + $("#lstFormulario").val() + "&respondidas=" + active,
                    dataType: 'json',
                    type: 'GET',
                    success: function (data) {
                        dados = data
                        Grid(data);
                    },
                    error: function (data) {
                        alert("erro");
                        console.log(data);
                    }
                });
            }
        } else {
            CarregaGrid();
        }
    }

    function Grid(dados) {
        $("#conteudo").empty();
        html = " <div style='overflow-x:auto;'>";
        html += "<table id='dtHorizontalExample' class='table table-striped table-bordered table-sm' cellspacing='0' width='100%'>";
        html += "<thead>";
        html += "<tr style='text-align:center;background-color: #e9ecef;'>";
        html += "<th colspan='4'></th>";
        html += "<th style='color: white;background:red'; colspan='3'>Operador</th>";
        html += "<th style='color: white;background: black;' colspan='5'>Líder</th>";
        html += "</tr>";
        html += "<tr style='text-align:center;background-color: #e9ecef;'>";

        html += "<th>Departamento</th>";
        html += "<th>Formulário</th>";
        html += "<th>Máquina</th>";
        html += "<th>Parte Máquia</th>";
        html += "<th>Data Notificação</th>";
        html += "<th>Operador</th>";
        html += "<th>Notificação</th>";
        html += "<th>Líder</th>";
        html += "<th>Obs Líder</th>";
        html += "<th>Data Obs Líder</th>";
        html += "<th>Lida</th>";
        html += "<th>Data Lida</th>";

        html += "</tr>";

        html += "</thead>";
        html += "<tbody>";
        if (dados.length > 0) {
            permissao = dados[0].permissao;
            for (var r = 0; r < dados.length; r++) {
                html += "<tr style='text-align:center;'>";

                html += "<td>" + dados[r].departamento + "</td>";
                html += "<td>" + dados[r].formulario + "</td>";
                html += "<td>" + dados[r].maquina + "</td>";
                html += "<td>" + dados[r].maquinaParte + "</td>";

                html += "<td>" + dados[r].dataNotificacao + "</td>";
                html += "<td>" + dados[r].id_nomeOperador + "</td>";
                html += "<td data-toggle='tooltip' title='Notificação Operador' ><button type='button' style='margin-left:8px;' class='btn btn-white' value=''  onclick=ModalobsOperador(" + dados[r].id + "); ><span style='color: gray;' class='glyphicon glyphicon-search' ></button></td>";
                //html += "<td>" + dados[r].notificacao + "</td>";
                html += "<td>" + dados[r].nomeLider + "</td>";
                if (dados[r].observacaoLider == "") {
                    //FUNCÇÃO QA         CÓDIGOS(CADASTRAPERGUNTA)
                    //FUNCÇÃO OPERADOR   CÓDIGOS(OPERADOR)
                    //FUNCÇÃO LIDER      CÓDIGOS(LIDER)

                    if (permissao == "CADASTRAPERGUNTA") {
                        html += "<td></td>";

                    }
                    else {

                        html += "<td data-toggle='tooltip' title='Obs Líder' ><button type='button' style='margin-left:8px;' class='btn btn-white' value=''  onclick=ModalObsLider(" + dados[r].id + ")><span style='color: gray;' class='glyphicon glyphicon-plus' ></button></td>";
                    }

                } else {
                    html += "<td data-toggle='tooltip' title='Obs Líder' ><button type='button' style='margin-left:8px;' class='btn btn-white' value=''  onclick=ModalNotificacaoObsLider(" + dados[r].id + ")><span style='color: gray;' class='glyphicon glyphicon-search' ></button></td>";
                }

                html += "<td>" + dados[r].dataObsLider + "</td>";

                if (dados[r].dataLeitura != "") {
                    html += "<td data-toggle='tooltip' title='Notificcação Lida' ><span style='color: red;' class='glyphicon glyphicon-eye-open' ></td>";
                } else {
                    html += "<td data-toggle='tooltip' title='Notificcação Lida' ><span style='color: gray;' class='glyphicon glyphicon-eye-open'></td>";

                }

                html += "<td>" + dados[r].dataLeitura + "</td>";
                html += "</tr>";
            }
        } else {
            html += "<tr style='text-align:center; color:red '>";
            html += "<td colspan='13'> Não existe nenhum registro com essa pesquisa. </td>";
            html += "</tr>";
        }

        html += "</tbody>";
        html += "</table>";
        html += "</div >";
        $("#conteudo").append(html);
    }

    function Tabela() {
        $("#conteudo").empty();
        html = " <div style='overflow-x:auto;'>";
        html += "<table id='dtHorizontalExample' class='table table-striped table-bordered table-sm' cellspacing='0' width='100%'>";
        html += "<thead>";
        html += "<tr style='text-align:center;background-color: #e9ecef;'>";
        html += "<th>Departamento</th>";
        html += "<th>Formulário</th>";
        html += "<th>Máquina</th>";
        html += "<th>Parte Máquia</th>";
        html += "<th>Data Notificação</th>";
        html += "<th>Operador</th>";
        html += "<th>Notificação</th>";
        html += "<th>Líder</th>";
        html += "<th>Obs Líder</th>";
        html += "<th>Data Obs Líder</th>";
        html += "<th>Lida</th>";
        html += "<th>Data Lida</th>";

        html += "</tr>";
        html += "</thead>";
        html += "<tbody>";

        html += "<tr style='text-align:center; color:red '>";
        html += "<td colspan='13'> Não existe nenhum registro com essa pesquisa. </td>";
        html += "</tr>";


        html += "</tbody>";
        html += "</table>";
        html += "</div >";
        $("#conteudo").append(html);

    }

    function ModalobsOperador(id) {

        $("#ModalNotificacao").modal('show');

        for (var i = 0; i < dados.length; i++) {

            if (dados[i].id == id) {
                $("#btnReposnderNotificacao").val(dados[i].id);
                $("#idtxtNotificacaoObs").val(dados[i].notificacao);
            }
        }
        //FUNCÇÃO QA         CÓDIGOS(CADASTRAPERGUNTA)
        //FUNCÇÃO OPERADOR   CÓDIGOS(OPERADOR)
        //FUNCÇÃO LIDER      CÓDIGOS(LIDER)
        if (permissao != "CADASTRAPERGUNTA") {
            LeituraNotificacao(id);
            Delay();
        } else {
            $("#btnReposnderNotificacao").prop('disabled', true);
        }
        $("#idtxtNotificacaoObs").prop('disabled', true);
        //Consultar();
    }


    function LimparCampo() {
        $("#msnObsLider").empty();
    }

    function ModalObsLider(id) {
        idRegistro = id;



        $("#msnObsLider").empty();
        $("#idtxtObsLider").val("");

        $("#ModalObsLider").modal('show');

    }

    function ModalNotificacaoObsLider(id) {



        $("#ModalNotificacaoObsLider").modal('show');

        for (var i = 0; i < dados.length; i++) {

            if (dados[i].id == id) {
                $("#idTxtNotificacaoObsLider").val(dados[i].observacaoLider);
            }
        }


    }

    function CadastrarObsLider() {


        if (validaObsLider()) {
            var id = 0;
            if (idRegistro.value != 0 && idRegistro.value != null) {
                id = idRegistro.value;
            } else {
                id = idRegistro;
            }

            var myData = "";
            myData = {
                id: id,
                observacaoLider: $("#idtxtObsLider").val().trim(),
            };


            $.ajax({
                url: "Atualizar/NotificacaoLider",
                type: 'POST',
                traditional: true,
                data: JSON.stringify(myData),
                contentType: 'application/json',
                success: function (response) {
                    ModalAlert(response.msn);


                    myData = "";



                }
            });
        }
        Delay();
        //Consultar();
    }

    function validaObsLider() {

        if ($("#idtxtObsLider").val() == "") {
            ModalAlert("Por favor, informe a notificação para salvar.");
            return false;
        }
        return true;

    }


    function ModalAlert(msn) {
        var resposta = '';
        $("#msnObsLider").empty();
        resposta = "<div class='alert alert-danger  text-center' role='alert'>" + msn + "</div>";
        $("#msnObsLider").append(resposta);
    }

    function Limpar() {

        $("#lstDepartamento").val("0");
        $("#lstMaquina").val("0");
        $("#lstParteMaquina").val("0");
        $("#lstFormulario").val("0");

        $("#lstFormulario").val("0");

        CarregaGrid();

    }

    function LeituraNotificacao(id) {

        var myData = "";
        myData = {
            id: id
        };

        $.ajax({
            url: "LeituraNotificacao/NotificacaoLider?idregistro=" + id,
            type: 'POST',
            traditional: true,
            data: JSON.stringify(myData),
            contentType: 'application/json',
            success: function (response) {
                ModalAlert(response.msn);

                myData = "";



            }
        });

    }

    function Delay() {


        var delayInMilliseconds = 2000; //2 second

        setTimeout(function () {
            Consultar();
        }, delayInMilliseconds);

    }



</script>

